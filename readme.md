# ADRB1 haplotype analysis

This repository contains code for detecting the haplotypes present in reads 
sequenced from amplicons of the ADRB1 ORF (NC_000010.11:114044133-114045566).
The target haplotype consists of a SNP at position 145 and another at 1165.

## Running the analysis

To run the analysis:
1. create a directory at the root of this repository named "bam".
2. create a subdirectory within `bam/` for each sample and place in it
a BAM file generated by mapping amplicon reads to adrb1.fa (found in root 
of repository).
3. Install `pysam` using `pip install pysam`, then execute the analysis using `python adrb1.py`

## Method

This method detects the haplotype of interest by interrogating the 145th
and 1165th bases of the aligned sequence.

## Alignment

Inputs to this analysis are BAM files generated by pbmm2. By default, pbmm2
excludes reads with an average score less than Q20 from processing. Hence, 
the number of "total aligning reads" on the TSV output will be less than the 
number of reads sequenced.

## Quality control

Input reads are at Q20 or above after upstream analysis (alignment by pbmm2).
Additionally, to pass QC, each read must also:
- have optimal mapping quality (i.e. 60 for pbmm2)
- include both target loci (e.g. not too short, target loci not deleted)

## Invalid haplotypes

A count is printed to the TSV file of the number of reads for which
the read passed QC, but the haplotype is not valid (i.e. not AG, AC, GC, or GG).

## A note on a strands

As a result of the PCR process, a large proportion of molecules in amplicon libraries
are [heteroduplexes](https://ccs.how/faq/mode-heteroduplex-filtering.html#what-is-a-heteroduplex).
During CCS analysis, heteroduplex reads are detected and separated by strand. This
means that BAM files will have two types of reads: stranded reads (sequence from a single strand 
which was part of a heteroduplex) and resolved reads (sequence where the molecule was not 
a heteroduplex and thus the strands were combined into one). Therefore, in this analysis, we 
will count individual strands.